---
layout: post
title: "바인더(1)"
date: 2020-04-06 00:00:01
author: Keelim
categories: AOSP
comments: true
toc: true
toc_sticky: true
---

- 안드로이드 바인더  
  - 바인더는 원래 IPC(Inter Process Communication) 도구이지만 안드로이드에는 다른 프로세스에 있는 함수 마치 현재 프로세스에 존재하는 함수처럼 사용할 수 있게 해주는 RPC(Remote Procedure Call) 지원하는 데 주로 이용.  
  
## 리눅스 메모리 공간과 바인더 드라이버  

- 안드로이드 기반 커널인 리눅스 커널 메모리 공간 이해  
- 안드로이드 프로세스는 프로세스만 고유한 가상 주소 공간에 실행  
- 가상 주소 공간은 사용자 공간과 커널 공간으로 나뉜다  
  - 사용자 코드와 관련 라이브러리는 사용자 공간 코드 영역, 데이터 영역, 스택 영역에 동작
  - 커널 공간에 동작해야할 코드는 커널 공간 각 영역에 동작

- 프로세스는 각자 독립된 주소 공간 가지고 별개로 동작
  - 독립된 공간 가지는 프로세스가 다른 프로세스에게 데이터 전달하는 방법: 프로세스 간 공유가 가능한 커널 공간 이용  
  - 커널 입장에 봤 때 프로세스는 하나 작업 단위, 커널 공간에 실행하는 태스크 데이터와 코드는 서로 공유.  

- 예 들어, 카메라로 찍은 사진 화면에 보여주는 경우  
  - 카메라 구동하는 프로세스, 사진 화면에 출력하는 프로세스
  - 카메라 동작하는 프로세스가 사진 찍은 후, 사진 화면에 출력하기 위해서는 출력 담당하는 프로세스  
  - 커널 공간 통해 화면 출력요청 메시지 전달
  -> 커널 공간 이용해 두 프로세스 사이 메시지 주고 받는 IPC 수행
  - 안드로이드에는 단순히 메시지 전달하는 IPC 개념이 아니라 상대방 프로세스에 존재하는 함수까지 호출할 수 있는 바인더라는 IPC 도구 채택해 프로세스간 RPC 지원
  - 카메라 경우, 카메라 구동하는 프로세스가 화면 출력 담당하는 프로세스 화면 출력함수 호출하여 사진 출력.  
  
- 프로세스 간 통신 제공하기 위해 커널 공간에 동작하는 Binder IPC Driver라는 추상화된 드라이버 이용  
  - 커널 공간 통한 데이터 전달 시 데이터 신뢰성 확보
  - 사용자 공간에 접근할 수 없는 공간인 커널 공간 이용해 데이터 주고 받기 때문에 IPC 간 보안 문제도 해결
  
## 안드로이드 바인더 모델: 바인더 동작 원리

- 바인더 역할: Surface Filger 동작  

![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-01.png)  

- 프로세스 A: 홈 스크린과 인디케이터 화면 출력, 서비스 클라이언트  
- 프로세스 B: 기기 대기 모드 표시 위한 잠금 화면 생성, 서비스 클라이언트  
- 프로세스 C: Surface(화면) 합성해서 프레임 버퍼(LCD 화면 버퍼)로 데이터 전송하는 Surface Flinger 서비스 제공하는 서비스 서버  
- Surface Flinger는 프로세스 A와 B가 건네주는 그래픽 화면 조합해서 LCD 화면에 출력 역할  
- 바인더는 각 프로세스 간에 수행되는 RPC 중재 역할  
- 프로세스 A와 B는 바인더 통해 Surface Flinger가 가진 LCD 출력 함수 호출해서 그래픽 출력

## 서비스 클라이언트가 바인더 통해 서비스 서버 함수 호출하는 과정

![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-02.png)  

- 서비스 클라이언트는 바인더 IPC 데이터(혹은 IPC 데이터) 서비스 서버로 전달  
- 바인더 드라이버는 foo() 함수 호출하기 위한 바인더 IPC 데이터 서비스 클라이언트에 서비스 서버로 전달하는 역할, 프로세스 간 통신 중재자 역할  
- 바인더 IPC 데이터
  - 상대편 프로세스 함수 호출 정보, 바인더 드라이버가 수행하는 IPC 데이터 단위  
  - 함수 호출과 관련된 내용(서비스에 해당하는 번호와 호출할 함수명), 바인더 프로토콜로 구성  
  - 서비스 번호: 안드로이드에 동작하는 서비스 구분짓기 위함  
  - 함수명: 서비스 서버에 동작하는 서비스 가운데 서비스 클라이언트가 호출할 함수 찾기 위함  
  - 바인더 프로토콜: 바인더 드라이버와 바인더 이용하는 프로세스 간 IPC 데이터 처리하는 규약  

- 바인더 IPC 데이터는 구조체 형태, 구조체 변수가 위 구성요소
  - 핸들: 서비스 구별하는 번호  
  - RPC 코드: 서비스에 호출할 함수  
  - RPC 데이터: 함수 인자, RPC 코드가 가리키는 함수에 전달할 인자 값
  - 바인더 프로토콜: IPC 데이터 처리 방법  
  
## 바인더 IPC 데이터 전달: 바인더 드라이버로 IPC 데이터 전달

- 바인더 드라이버는 시스템 콜 통해 접근 가능
(1) 바인더 통해 RPC 시도하는 애플리케이션은 open() 시스템 콜 통해 바인더 드라이버 파일 디스크립터 얻음
(2) mmap() 시스템 콜 통해 커널 내에 IPC 데이터 수신하기 위한 공유 공간 확보
(3) ioctl() 함수 인자로 바인더 드라이버에 IPC 데이터 전달

## 바인더 IPC 데이터 흐름: 바인더 IPC 데이터가 서비스 클라이언트에 서비스 서버로 전달되기까지 과정

- 서비스 클라이언트에 서비스 서버 foo() 함수 호출하기 위해 RPC 시도할 때 바인더 IPC 데이터 전달 과정

![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-05.png)  

- 서비스 클라이언트가 서비스 사용하기 위한 추상 계층  
  - 서비스 클라이언트는 하위 계층에 제공하는 동작 통해 서비스 계층에 RPC 수행  
  - 서비스 계층 아래에 있는 계층에는 서비스 계층 RPC 지원하기 위한 바인더 IPC 데이터 생성  
  
- 서비스 계층  
  - 특정 기능 수행하는 서비스 함수가 존재하는 계층
  - 서비스 클라이언트는 서비스 함수 가상으로 호출, 서비스 서버는 서비스 클라이언트가 요청한 서비스 함수 실제 호출  

- RPC 계층  
  - 서비스 클라이언트는 이 계층에 서비스 함수 호출하기 위한 RPC 코드와 RPC 데이터 생성  
  - 서비스 서버는 전달받은 RPC 코드 토대로 함수 찾고 RPC 데이터 전달  

- IPC 계층  
  - RPC 코드와 RPC 데이터 바인더 드라이버에 전달하기 위한 바인더 IPC 데이터로 캡슐화

- 바인더 드라이버 계층  
  - 바인더 IPC 데이터 통해 서비스 가진 서비스 서버 찾은 후 IPC 데이터 전달  
  - 바인더 드라이버는 IPC 데이터에 바인더 프로토콜 파악하여 데이터 전달 여부 결정  

## 바인더 프로토콜

- 바인더 프로토콜  
  - 바인더 드라이버는 IPC 데이터에 바인더 프로토콜 파악하여 데이터 전달 여부 결정  
  - 바인더 IPC 데이터에 포함  

  - 바인더 프로토콜 전달 방향  
    - IPC 계층에 바인더 드라이버로 전달: Binder Command Protocol(BC_)
    - 바인더 드라이버에 IPC 계층으로 전달: Binder Return Protocol(BR_)

  - 데이터 송신하는 측과 수신하는 측에 모두 알고 있는 규약  
    - 바인더 IPC 이용하는 프로세스와 바인더 드라이버는 헤더 파일에 바인더 프로토콜 정  

![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-07.png)  

- IPC 데이터 전달할 때 사용하는 바인더 프로토콜: BC_TRANSACTION, BR_TRANSACTION  
  - 서비스 클라이언트는 BC_TRANSACTION 프로토콜 통해 바인더 드라이버에 IPC 데이터 전달 명령  
  - 바인더 드라이버는 전달받은 IPC 데이터 토대로 바인더 프로토콜이 BC_TRANSACTION이면 IPC 데이터 핸들 통해 서비스 서버 찾는다  
  - 이후 바인더 드라이버는 바인더 프로토콜 BR_TRANSACTION으로 변경하고, 이 IPC 데이터에 실어서 서비스 서버로 전달  
  - 서비서 서버는 전달받은 바인더 프로토콜이 BR_TRANSACTION인지 체크한 후, IPC 데이터 분석해서 서비스 사용자가 요청한 함수 호출  

## RPC 코드와 RPC 데이터

- RPC 코드: 서비스 클라이언트가 서비스 서버에 존재하는 서비스 함수 사용하기 위해 각 함수에 해당하는 식별자 바인더 IPC 데이터에 담아 전달
- RPC 데이터: 함수 인자 IPC 데이터에 담아 전달  
- 서비스 서버가 가진 서비스 함수 호출하려면 서비스 클라이언트에는 반드시 서비스 서버가 가진 RPC 코드

![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-08.png)  

- Audio Flinger 서비스 사용하는 MP3 애플리케이션 경우  
  - 음악 재생 중 볼륨 조정이 필요한 경우, 하드웨어 볼륨 조정 담당하는 Audio Flinger 서비스 가진 서비스 서버에게 요청  
  - 볼륨 조정 하는 함수 미하는 SET_MASTER_VOLUME RPC 코드와 원하는 볼륨값인 RPC 데이터 IPC 데이터에 담아 서비스 서버 보냄
  - 서비스 서버는 전달받은 IPC 데이터에 RPC 코드 파악하고, RPC 코드가 SET_MASTER_VOLUME일 경우 Audio Flinger에 setMasterVolume() 함수 호출  
  - MP3 애플리케이션은 볼륨 조정
  
## 바인더 어드레싱

- 컨텍스트 매니저(Context Manager): 다양한 서비스 모두 목록화해서 관리하는 프로세스
  - 서비스마다 핸들이라는 번호 값 할당: 핸들은 바인더 IPC 목적지 주소로 사용
  - 서비스 추가/검색 등 관리 기능 수행
  - 컨텍스트 매니저 핸들 값은 0이다  

- 바인더 드라이버는 IPC 데이터 핸들 가지고 서비스 서버 찾는다: 바인더 어드레싱(Binder Addressing)  
- 바인더 어드레싱 위해 서비스 서버는 자신이 가진 서비스에 대한 접근 정보 컨텍스트 매니저에 등록  
  - 서비스 등록 과정에 서비스 서버는 ADD_SERVICE(RPC 코드), 등록할 서비스 이름(RPC 데이터), 핸들 0으로 지정한 IPC 데이터 바인더 드라이버에 전달  
  
![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-09.png)  

- 서비스 서버가 자신 서비스 컨텍스트 매니저에게 등록할 때 바인더 어드레싱 과정  
  - 바인더 드라이버는 먼저 핸들 0에 해당하는 바인더 노드 찾는다  
  (바인더 노드는 서비스마다 하나씩 존재하는 바인더 드라이버 내 자료구조. 프로세스마다 바인더 노드들 리스트로 가진다)  
  - 핸들 0에 해당하는 바인더 노드는 컨텍스트 매니저이므로 서비스 서버는 IPC 데이터 컨텍스트 매니저에게 전달한다  
  - 바인더 드라이버는 서비스 서버에 서비스 A에 해당하는 바인더 노드 하나 생성  
  - 컨텍스트 매니저가 생성된 바인더 노드 알 수 있게 바인더 노드 참조 데이터 생성해 해당 노드 연결  
  - 참조 데이터는 생성된 순서대로 번호가 매겨진다  
  - 이 번호는 IPC 데이터에 담겨 컨텍스트 매니저로 전달된다  
  - 컨텍스트 매니저는 IPC 데이터에 들어 있는 서비스 이름과 바인더 노드 번호 서비스 리스트에 등록
  - 컨텍스트 매니저 서비스 목록, 바인더 드라이버 바인더 노드, 서비스 서버 서비스가 연결
  
## 서비스 클라이언트가 서비스 검색하는 과정

![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-10.png)  

- 서비스 클라이언트가 서비스 검색하는 과정: 서비스 클라이언트가 서비스 검색할 때 바인더 어드레싱  
  - 서비스 클라이언트는 GET_SERVICE라는 RPC 코드와 요청할 서비스 이름(RPC 데이터), 핸들 0으로 지정한 IPC 데이터 바인더 드라이버 통해 컨텍스트 매니저에게 전달  
  - 컨텍스트 매니저는 서비스 이름에 해당하는 서비스 번호 찾은 다음 이 바인더 드라이버에 전달  
  - 바인더 드라이버는 서비스 목록 번호에 해당하는 참조 데이터 찾음
  - 서비스 클라이언트 쪽에 참조 데이터 생성해 컨텍스트 매니저 참조 데이터가 가리키는 바인더 노드 연결
  (연결된 바인더 노드는 서비스 서버가 자신 서비스 위해 생성했던 바인더 노드이다)  
  - 바인더 드라이버는 생성한 참조 데이터 생성된 순서대로 번호 매겨 서비스 클라이언트에게 알려준다  
  - 서비스 클라이언트는 이 번호 핸들로 지정하여 서비스 서버 바인더 노드 찾는다  
  
## 바인더 어드레싱 통해 서비스 사용하는 과정  

![BinderIPC](https://raw.githubusercontent.com/keelim/AOSP/master/docs/assets/ipc-11.png)  

- 서비스 클라이언트는 참조 데이터 번호 핸들에 저장  
- 사용할 서비스 함수에 해당하는 RPC 코드와 RPC 데이터 IPC 데이터에 담아 서비스 서버로 전달하여 서비스 A가 가진 함수 호출

## 바인더 내용 추가 (인터널 바인더)
