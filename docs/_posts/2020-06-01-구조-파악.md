---
layout: post
title: "êµ¬ì¡° íŒŒì•… Window (ë‹¤ì‹œí•œë²ˆ)"
date: 2020-06-01 00:00:01
author: Keelim
categories: AOSP
comments: true
toc: true
toc_sticky: true
---

## WindowMangerì— ê´€í•˜ì—¬

ì½”ë“œë¥¼ ê³„ì† ë³´ë©´ì„œ ê°ì„ ì¡ì€ ê²ƒ dê°™ë‹¤.
ìš°ì„  WindowManger ì—­í• ì€ 3ê°€ì§€ `Windowê´€ë¦¬`, `ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬`, `ë ˆì´ì•„ì›ƒ`

![êµ¬ì„±](https://github.com/keelim/AOSP/blob/master/docs/assets/repeat0.png?raw=true)
![êµ¬ì„±](https://github.com/keelim/AOSP/blob/master/docs/assets/repeat1.png?raw=true)

- - -
![êµ¬ì„±](https://github.com/keelim/AOSP/blob/master/docs/assets/repeat2.png?raw=true)

- `1` Activityì˜ ë‚´ë¶€ ì¤€ë¹„ í”„ë¡œì„¸ìŠ¤ì—ëŠ” ì¤‘ìš”í•œ ì»¨í…ìŠ¤íŠ¸ ì¸ ContextImplì´ ìƒì„±ë˜ëŠ”ë°,
ì´ëŠ” Context í´ë˜ìŠ¤ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ êµ¬í˜„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.ì´ í´ë˜ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œìŠ¤í…œ ìì›ì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ (ì˜ˆ : ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ì—¬ ê°€ì ¸ ì˜¤ê¸°ìœ„í•œ) ì¼ë¶€ ê¸°ë³¸ APIë¥¼ ìº¡ìŠí™”.
IBinder, ì¸í…íŠ¸ ë³´ë‚´ê¸°, ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ì •ë³´ ì–»ê¸°, ë°ì´í„°ë² ì´ìŠ¤ ì•¡ì„¸ìŠ¤ ë“±.
ì• í”Œë¦¬ì¼€ì´ì…˜ë³´ê¸°ì—ì„œ ì „ì²´ Android SDKì˜ ì‹œì‘ì ì…ë‹ˆë‹¤. ContextImpl êµ¬í˜„ í•¨ìˆ˜ ì™¸ì—ë„ í˜„ì¬ ì‘ìš© í”„ë¡œê·¸ë¨ ì¶œë ¥ì˜ í‘œì‹œ ì¥ì¹˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” mDisplayê°€ìˆëŠ” ë©¤ë²„ ë³€ìˆ˜ë„ ìœ ì§€.
ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ì¼ë°˜ì ìœ¼ë¡œ íœ´ëŒ€í°ì˜ LCD í™”ë©´ê³¼ ê°™ì€ ì‹œìŠ¤í…œì˜ ê¸°ë³¸ ë””ìŠ¤í”Œë ˆì´ ì¶œë ¥ì„ ê°€ë¦¬ í‚µë‹ˆë‹¤.

- `2` addView (view, param)ë¥¼ í˜¸ì¶œí•˜ë©´ ViewRootê°€ ìƒì„±ë©ë‹ˆë‹¤. addView ()

```java
public void addView(View view, ViewGroup.LayoutParams params) {
        mGlobal.addView(view, params, mDisplay, mParentWindow);
}

public void addView(View view, ViewGroup.LayoutParams params,Display display, Window parentWindow){
       //
       root = new ViewRootImpl(view.getContext(), display);
       //
}
```

ë§¤ê°œ ë³€ìˆ˜ëŠ” WindowManagerServiceì— ì¶”ê°€í•˜ë ¤ëŠ” `"Window"`ì…ë‹ˆë‹¤.
Activityì—ëŠ” `Window`ë§Œ í•„ìš”. ë”°ë¼ì„œ Activyì˜ ê¸°ë³¸ êµ¬í˜„ì€ DecorViewë¥¼ ê´€ë¦¬ë¥¼ ìœ„í•´ Window ê´€ë¦¬ì ì„œë¹„ìŠ¤ì— "Window"ìœ¼ë¡œ ì§€ì •.
ParamsëŠ” ê¸¸ì´, ë„ˆë¹„ ë° ê°€ì¥ìë¦¬ í¬ê¸°ì™€ ê°™ì€ ì •ë³´ê°€ í¬í•¨ ëœ ë ˆì´ì•„ì›ƒ ê´€ë ¨ ë§¤ê°œ ë³€ìˆ˜.

MarDisplayëŠ” Windowì—ì„œ ì¶œë ¥í•˜ë ¤ëŠ” â€‹â€‹ë””ìŠ¤í”Œë ˆì´ ì¥ì¹˜ ë²ˆí˜¸ì´ë©° ContextImplì— ì˜í•´ ì „ë‹¬ë©ë‹ˆë‹¤.
mParentWindowëŠ” Activityì˜ ë©¤ë²„ ë³€ìˆ˜ mWindowì…ë‹ˆë‹¤.
ìµœìƒìœ„ í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ì—ì„œ ì‰½ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íœ´ëŒ€í°ì˜ ê²½ìš° PhoneWindow ê°ì²´ì…ë‹ˆë‹¤. GoogleTVì˜ ê²½ìš° TVWindow ê°ì²´.

- `3` ViewRootImplì€ Surface ê°ì²´ (ìœ íš¨í•œ ê°’ì´ í• ë‹¹ë˜ì§€ ì•Šì€ ë¹ˆ Surface ê°ì²´ì´ë©° CopyFromParcelë¡œ ì±„ì›Œì§) ë°
mChoreophaer íƒ€ì´ë¨¸ (Singleton ê°ì²´)ë¥¼ í¬í•¨í•˜ì—¬  ë©¤ë²„ ë³€ìˆ˜ë¡œ êµ¬ì„± í”„ë¡œì„¸ìŠ¤ì—ì„œ ì´ˆê¸°í™”.
ViewRootImpëŠ” WindowManagerGlobalì„ í†µí•´ WindowManagerServiceë¡œ í˜¸ì¶œ ì±„ë„ì„ ìƒì„± í•œ ë‹¤ìŒì´ ì±„ë„ì„ ì‚¬ìš©í•˜ì—¬ ì¶”ê°€ ì´ˆê¸°í™”ë¥¼ ìˆ˜í–‰.

- `4` ì—¬ì „íˆ addView ()ì—ì„œ WindowManagerImplì€ ViewRoot ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ í›„ setView ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ê³  ë·° ë° ë ˆì´ì•„ì›ƒ ë§¤ê°œ ë³€ìˆ˜ë¥¼ ViewRootImplì— ì „ë‹¬í•˜ì—¬ ëŒ€ì²´.
setView ()ì˜ ViewRootImplì€ ì‚¬ìš©ì í‚¤ ì…ë ¥ì„ ìˆ˜ì‹ í•˜ê¸°ìœ„í•œ InputChannel ì‘ì„±,ê·¸ë˜í”½ í•˜ë“œì›¨ì–´ ê°€ì† ì‚¬ìš©, 
ì²« ë²ˆì§¸ ë ˆì´ì•„ì›ƒ ìš”ì²­ ë“±ì„ í¬í•¨í•œ ì¶”ê°€ ì´ˆê¸°í™” ì‘ì—…ì„ ìˆ˜í–‰. ì—¬ê¸°ì„œëŠ” WindowManagerServiceì™€ ê´€ë ¨ëœ ê²ƒ,
ì¦‰ WindowManagerì— ëŒ€í•´ì„œë§Œ ì†Œê°œ. ì„œë¹„ìŠ¤ ë³´ê³ ì„œëŠ” WindowManagerì˜ Window ê´€ë¦¬ì ëŒ€ê¸°ì—´ì— ì¶”ê°€ë©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” addToDisplay ()ì…ë‹ˆë‹¤.
`Session` ë¶€ë¶„ì´ IPC


```java
Int addToDisplay(IWindow window, //callback interface provided to WMS
     in int seq,
           In windowManager.LayoutParams attrs, // layout parameter
     in int viewVisibility, in int layerStackId,     // display ID
           Out Rect outContentInsets, // return the position of this View on the display after WMS calculation
           Out InputChannel outInputChannel); // User input channel Handle
```

addToDisplay ()ëŠ” ê²°êµ­ WindowManager ì„œë¹„ìŠ¤ì˜ addWindow () ì¸í„°í˜ì´ìŠ¤ë¡œ ë³€í™˜

- `5` AddWindow ()ëŠ” ë¨¼ì € WindowManager ì„œë¹„ìŠ¤ ì¸¡ì˜ ViewRootImplì„ ë‚˜íƒ€ë‚´ëŠ” WindowState ê°ì²´ë¥¼ ìƒì„±.
ìƒì„±ìì—ì„œ `WindowStateëŠ” IWindowId.Stub ê°ì²´ì™€ DeathRecipient ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ê°ê° í¬ì»¤ìŠ¤ ë° ìœˆë„ìš° ë°ìŠ¤ ì •ë³´ë¥¼ ìˆ˜ì‹ .`
Windowì˜ mBaseLayer, mSubLayer ë° mLastLayer ê°’ì€ ê¸°ë³¸ Windowì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì „ë‹¬í•œ Window ìœ í˜•ì— ë”°ë¼ ê³„ì‚°ë©ë‹ˆë‹¤. ,
í•˜ìœ„ Window (ì˜ˆ : ì…ë ¥ ë°©ë²•)ì— íŒì—…ì´ í‘œì‹œë˜ê³  ì• ë‹ˆë©”ì´ì…˜ì˜ í•´ë‹¹ ZOrder ê°’ ì´ ì „ì²´ Windowì˜ ì• ë‹ˆë©”ì´ì…˜ì„ ë‹´ë‹¹í•˜ëŠ” WindowStateAnimationì„ ìƒì„±í•˜ê³  ë‚´ë¶€ì ìœ¼ë¡œ ì—°ê²°
windowToken, appWindowToken ë“±ì´ ì¼ì–´ë‚©ë‹ˆë‹¤.

- `6` WindowManager ì„œë¹„ìŠ¤ëŠ” `openInputChannelPair ()` ë° `RegisterInputChannel ()` ì„ í˜¸ì¶œí•˜ì—¬
í†µì‹ ìš© SocketPairë¥¼ ì‘ì„±í•˜ê³  ë‹¤ìŒ ì‚¬ìš©ì ì…ë ¥ ì´ë²¤íŠ¸ì— í•´ë‹¹í•˜ëŠ” ì‘ë‹µ Windowì— ëŒ€í•´ InputManagerServiceë¡œ ì „ë‹¬ ( Android ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ ì°¸ì¡° ).

- `7` WindowManagerServiceëŠ” `WindowState` ì˜ attach ()ë¥¼ í˜¸ì¶œí•˜ê³ 
Surface Sessionì„ ë§Œë“¤ê³  Surface Session, WindowSession ë° WindowStateë¥¼ ì—°ê²°.

- `8` WindowManager ì„œë¹„ìŠ¤ëŠ” `assignLayersLocked ()`ë¥¼ í˜¸ì¶œí•˜ì—¬ ëª¨ë“  Windowsì— ëŒ€í•œ `Z-Order`ë¥¼ ê³„ì‚°.
% Z-order í™”ë©´ì˜ ìˆœì„œ

- `9` addToDisplay ()ëŠ” ViewRootImpl ë° WindowManager Service ë‚´ë¶€ì˜ ì¤€ë¹„ê°€ ì¤€ë¹„ë˜ì—ˆìŒì„ ë°˜í™˜.
ActivityThreadëŠ” ACTIVITY_RESUMED ë©”ì‹œì§€ë¥¼ ë³´ë‚´ Activityì„ ì‹œì‘í•˜ë„ë¡ ì•Œë ¤ì¤ë‹ˆë‹¤. ê·¸ë¦¼ì´ ì•„ì§ ê·¸ë ¤ì§€ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì˜ˆ, SurfaceëŠ” ì•„ì§ ì´ˆê¸°í™” ì•ˆë¨.

![êµ¬ì„±](https://github.com/keelim/AOSP/blob/master/docs/assets/repeat3.png?raw=true)

## ì°¸ê³ 

- [<https://developer.android.com/>]
- [<http://oss.kr/]>
- ì¸ì‚¬ì´ë“œ ì•ˆë“œë¡œì´ë“œ
- [<https://cs.android.com/>]
- [<https://jungwoon.github.io/android/2019/10/02/How-to-draw-View/>]
- [<https://wooooooak.github.io/kotlin/2019/08/25/%EC%BD%94%ED%8B%80%EB%A6%B0-%EC%BD%94%EB%A3%A8%ED%8B%B4-%EA%B0%9C%EB%85%90-%EC%9D%B5%ED%9E%88%EA%B8%B0/>]
- [<http://www.programmersought.com/article/1775756750/>]

#### ğŸ§¶ ëª¨ë“  ë¬¸ì„œëŠ” ìˆ˜ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.