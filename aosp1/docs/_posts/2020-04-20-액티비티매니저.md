---
layout: post
title: "ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ë¶„ì„"
date: 2020-04-20 00:00:01
author: Keelim
categories: AOSP
comments: true
toc: true
toc_sticky: true
---

## ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤

![ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰í™”ë©´](https://user-images.githubusercontent.com/48465809/58676123-173f5080-8392-11e9-9935-5bb3dd38e1cd.jpg)

- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤: ìë°” ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ì´ë©°, ì•ˆë“œë¡œì´ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»´í¬ë„ŒíŠ¸(ì•¡í‹°ë¹„í‹°, ì„œë¹„ìŠ¤, ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë¦¬ì‹œë²„ ë“±)ë¥¼ ìƒì„±í•˜ê³ , ì´ë“¤ì˜ `ìƒëª…ì£¼ê¸°`ë¥¼ ê´€ë¦¬í•œë‹¤  
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ì˜ ì‹¤í–‰ì„ ìš”ì²­í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ì™€ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì–´ë–»ê²Œ ìƒí˜¸ì‘ìš©í•˜ëŠ”ê°€  
- Remot Service Controller ì˜ˆì œ ì• í”Œë¦¬ì¼€ì´ì…˜: 'Start Service' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ Remote Servcieê°€ ì‹œì‘ë˜ëŠ” í”„ë¡œê·¸ë¨  
- ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ë©´, ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìš”ì²­í•œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•œë‹¤  

- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì–´ë–»ê²Œ RemoteServiceë¥¼ ì‹¤í–‰í• ê¹Œ?  
- RemoteServiceëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ë…ë¦½ëœ í”„ë¡œì„¸ìŠ¤ì—ì„œ ë™ì‘í•˜ëŠ” ë¦¬ëª¨íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ì´ë‹¤. ë”°ë¼ì„œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ìš°ì„  ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•´ì•¼í•œë‹¤.  
- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” Zygoteë¥¼ ì´ìš©í•´ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•  í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒì„±í•œ í›„, í”„ë¡œì„¸ìŠ¤ ìƒì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ìš”ì²­í•œ RemoteServiceë¥¼ ì‹¤í–‰í•œë‹¤.  

![RemoteService](https://user-images.githubusercontent.com/48465809/58676124-173f5080-8392-11e9-8243-c2e984485a30.jpg)

- êµ¬ì²´ì ì¸ ê³¼ì •

(1) startService() APIë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ì‹œì‘ ìš”ì²­(ë°”ì¸ë” RPC ì´ìš©) ('Start Service'ë²„íŠ¼ ëˆ„ë¥´ê³ , ActivityManagerServiceì—ê²Œ)  
ì• í”Œë¦¬ì¼€ì´ì…˜ì€ startService()ë‚˜ bindService() APIë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.  

(2) ActivityThread ìƒì„± ìš”ì²­ (Unix Domain Socket ì´ìš©) (AcitivityManagerServiceì—ì„œ Zygoteë¡œ)  
ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œë¶€í„° startService()ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ì‹¤í–‰ìš”ì²­ì„ ë°›ì€ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” ìš”ì²­ë°›ì€ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ActivityThread ìƒì„±ìš”ì²­ì„ Zygoteì—ê²Œ í•œë‹¤.  
(ActivityThread: ëª¨ë“  ì•ˆë“œë¡œì´ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”ì¸ ìŠ¤ë ˆë“œ, ì•¡í‹°ë¹„í‹° ë° ì„œë¹„ìŠ¤ì˜ ìƒì„± ë° ìŠ¤ì¼€ì¤„ë§ì„ ë‹´ë‹¹)  

(3) ActivityThread ìƒì„± (Zygoteì—ì„œ ActivityThreadë¡œ)  
ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ë¡œë¶€í„° ActivityThread ì‹¤í–‰ì„ ìš”ì²­ë°›ì€ ZygoteëŠ” ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒì„±í•œ ë‹¤ìŒ ê·¸ ìœ„ì— ActivityThread í´ë˜ìŠ¤ë¥¼ ë¡œë”©í•œë‹¤  

(4) RemoteService ìƒì„± ìš”ì²­ (ë°”ì¸ë” RPC ì´ìš©) (ActivityManagerServiceì—ì„œ ActivityThreadë¡œ)  
ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” ActivityThreadì—ê²Œ RemoteService ì„œë¹„ìŠ¤ì˜ ìƒì„±ì„ ìš”ì²­í•œë‹¤.  

(5) RemoteService ìƒì„±  
ActivityThreadëŠ” RemoteServiceë¥¼ ì‹¤í–‰í•œë‹¤.  

![ì•¡í‹°ë¹„í‹° ìƒëª…ì£¼ê¸°](https://developer.android.com/guide/components/images/activity_lifecycle.png)

![ì•ˆë“œë¡œì´ë“œ ì„œë¹„ìŠ¤ ìƒëª…ì£¼ê¸°](https://developer.android.com/images/service_lifecycle.png?hl=ko)

## ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ë¥¼ í†µí•œ ì„œë¹„ìŠ¤ ìƒì„± ì½”ë“œ ë¶„ì„

- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì–´ë–»ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ”ê°€

### Controller ì•¡í‹°ë¹„í‹° - startService() ë©”ì„œë“œ í˜¸ì¶œ

- 'Start Service' ë²„íŠ¼ -> ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í˜¸ì¶œ -> intentë¥¼ ì¸ìë¡œ startService() API ë©”ì„œë“œë¥¼ í˜¸ì¶œ  
- ì•ˆë“œë¡œì´ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»´í¬ë„ŒíŠ¸ëŠ” ì¸í…íŠ¸ë¼ëŠ” ë©”ì‹œì§€ë¥¼ í†µí•´ í™œì„±í™”ëœë‹¤. ì•ˆë“œë¡œì´ë“œì—ì„œëŠ” ì¸í…íŠ¸ë¥¼ ì´ìš©í•´ ì‹¤í–‰í•˜ê³ ì í•˜ëŠ” ì„œë¹„ìŠ¤ì˜ í´ë˜ìŠ¤ëª…ì„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•´ì„œ ì›í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.  

```java
private OnClickListener mStartListener = new OnClickLister(){
  public void onClick(View v){
    statService(new Intent("com.example.android.apis.app.Remote_Service"));
  }
}
//startService, intent, ì•”ì‹œì , ëª…ì‹œì 
```

### ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì˜ startService() ë©”ì„œë“œ í˜¸ì¶œ ê³¼ì •(ë°”ì¸ë” RPC í™œìš©)

- startService() API: ì•¡í‹°ë¹„í‹°ì—ì„œ í˜¸ì¶œ, ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì—ê²Œ ì„œë¹„ìŠ¤ ìƒì„± ë° ì‹¤í–‰ê³¼ ê´€ë ¨ëœ ë‚´ìš©ì„ ìš”ì²­  
- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì— ì†í•œ startService() ìŠ¤í… ë©”ì„œë“œ: ì‹¤ì œ êµ¬í˜„  

=> startService() APIëŠ” ìë°” ì„œë¹„ìŠ¤ í”„ë ˆì„ì›Œí¬ ê¸°ë°˜ì—ì„œ ë°”ì¸ë” RPC í˜•íƒœë¡œ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” startService() ìŠ¤í… ë©”ì„œë“œë¥¼ í˜¸ì¶œ  ìœ„ì˜ (1)ë²ˆ ê³¼ì • êµ¬ì²´í™”

1. Controller Activity - ActivityManagerProxy ê°ì²´ì˜ startService() proxy method í˜¸ì¶œ  
2. ActivityManagerProxy ê°ì²´ - ìë°” ì„œë¹„ìŠ¤ í”„ë ˆì„ì›Œí¬ë¥¼ í†µí•´ ActivityManagerNative ê°ì²´ì— START_SERVICE_TRANSACTION RPC ì½”ë“œì™€ ë°”ì¸ë” RPC ë°ì´í„°ë¥¼ ì „ì†¡  
3. ActivityManagerNative ê°ì²´ - ActivityManagerServiceì— í¬í•¨ëœ startService() ìŠ¤í… ë©”ì„œë“œë¥¼ í˜¸ì¶œ


### (1) Controller ì•¡í‹°ë¹„í‹°

(a) ContextWrapper í´ë˜ìŠ¤ - ContextImpl ê°ì²´ì˜ startService() ë©”ì„œë“œ í˜¸ì¶œ

```java
public class ContextWrapper extends Context{
  Context mBase;

  public ComponentName startService(Intent service){
    return mBase.startService(service)
  }
}
```

- ì•¡í‹°ë¹„í‹°ì—ì„œ startService() API í˜¸ì¶œ -> Activity í´ë˜ìŠ¤ê°€ ìƒì†í•˜ëŠ” ContextWrapper í´ë˜ìŠ¤ì˜ startService()ê°€ í˜¸ì¶œ  
- ContextWrapper: Context ì¶”ìƒ í´ë˜ìŠ¤ë¥¼ í™•ì¥í•œ í´ë˜ìŠ¤, ë©¤ë²„ ë³€ìˆ˜ mBaseì— ì €ì¥ëœ Context ê°ì²´ë¥¼ wrappingí•˜ëŠ” ì—­í•   
- ContextWrapper ê°ì²´ëŠ” Controller ì•¡í‹°ë¹„í‹°ì˜ ContextImpl ê°ì²´ë¥¼ ë˜í•‘  
=> ContextWrapperì˜ startService() ë©”ì„œë“œëŠ” ê²°êµ­ ContextImpl ê°ì²´ì˜ startServiceë¥¼ í˜¸ì¶œí•œë‹¤.  

(b) ContextImpl í´ë˜ìŠ¤ - startService() ë©”ì„œë“œ ì²˜ë¦¬  

- ContextImpl: Context ì¶”ìƒ í´ë˜ìŠ¤ë¥¼ ì‹¤ì œ êµ¬í˜„í•œ í´ë˜ìŠ¤, ì• í”Œë¦¬ì¼€ì´ì…˜ ìì²´ì˜ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼, ì•¡í‹°ë¹„í‹°ë‚˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ ì‹¤í–‰, ì¸í…íŠ¸ ì†¡ìˆ˜ì‹  ë“±ì˜ ì—­í• ì„ ìˆ˜í–‰

```java
public ComponentName startService(Intent service){
  ComponentName cn = ActivityManagerNative.getDefault().startService(
      mMainThread.getApplication(), service,
      service.resilveTypeIfNeeded(getContentResolver());
  )
}
```

- ActivityManagerNative.getDefault().startService() ì²˜ë¦¬ ê³¼ì •
- ActivityManagerNative.getDefault() í•¨ìˆ˜ëŠ” ê²°êµ­ ActivityManagerProxy ê°ì²´ë¥¼ ë°˜í™˜, ì´ ê°ì²´ëŠ” ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì œê³µí•˜ëŠ” IActivityManager ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ì˜ ë©”ì„œë“œë“¤ì„ ë°”ì¸ë” RPCë¥¼ í†µí•´ì„œ í˜¸ì¶œí•˜ëŠ” ì—­í• ì„ í•œë‹¤.  


- ActivityManagerProxyì˜ startService()ëŠ” ê²°êµ­ ActivityManagerServiceì˜ startService() ìŠ¤í… ë©”ì„œë“œë¥¼ ì›ê²©ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•œë‹¤. ë‘ startService() ë©”ì„œë“œëŠ” ë™ì¼í•œ í•¨ìˆ˜ ì›í˜•ì„ ì‚¬ìš©í•œë‹¤.  

```java
public ComponentName startService(IApplicationThread caller, Intent service, String resolvedType)
```

í•¨ìˆ˜ì›í˜•

### (2) ActivityManagerProxy ê°ì²´

```java
public ComponentName startService(IApplicationThread caller, Intent service, String resolvedType){
  Parcel data = Parcel.obtain();
  Parcel reply = Parcel.obtain();

  //ì „ì†¡ ë°ì´í„° ì €ì¥
  data.writeStrongBinder(caller !=null ? caller.asBinder() : null); //3í•­ ì—°ì‚°ì?
  service.writeToParcel(data, 0);
  data.writeString(resolvedType);


  mRemote.transact(START_SERVICE_TRANSACTION, data, reply, 0);
  ComponentName res = ComponentName.readFromParcel(reply);
  return res; // êµ³ì´ í• ë‹¹ì„ í•´ì„œ?
}
```

- ActivityManagerProxy ê°ì²´ì˜ startService() í”„ë¡ì‹œ ë©”ì„œë“œê°€ ì²˜ë¦¬í•˜ëŠ” ë‚´ìš©  
- ActivityManagerProxy ê°ì²´ëŠ” ActivityManagerNative ê°ì²´ì— ë°”ì¸ë” RPC ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒì´ë‹¤.  
<!-- Parcel ì— ì €ì¥ì„ í•˜ê³  transact ë¥¼ í†µí•´ Nativeìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤. -->

### (3) ActivityManagerNative ê°ì²´

- ìˆ˜ì‹ ëœ ë°”ì¸ë” RPC ë°ì´í„°ëŠ” ActivityManagerNative ê°ì²´ì˜ onTransact() ë©”ì„œë“œì—ì„œ ì²˜ë¦¬  
- RPC ì½”ë“œë¥¼ í† ëŒ€ë¡œ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì—ì„œ í˜¸ì¶œí•  ìŠ¤í… ë©”ì„œë“œë¥¼ íŒŒì•…  
- onTransact() ë©”ì„œë“œì˜ ì—­í•   
  - ActivityManagerProxyì˜ startService() í”„ë¡ì‹œ ë©”ì„œë“œì˜ ì¸ì ê°’ì´ ë§ˆìƒ¬ë§ëœ dataë³€ìˆ˜(Parcel ê°ì²´)ë¥¼ ë°”ì¸ë” RPCë¥¼ í†µí•´ ìˆ˜ì‹ í•œ ë‹¤ìŒ, data ë³€ìˆ˜ë¥¼ ì–¸ë§ˆìƒ¬ë§í•˜ê³  ê° ë°ì´í„°ë¥¼ ë³„ë„ì˜ ë³€ìˆ˜ì— ì €ì¥í•œë‹¤.  

- ì•¡í‹°ë¹„í‹°ëŠ” IActivityManager ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ì˜ ë°”ì¸ë” RPCë¥¼ í†µí•´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì—ê²Œ ì„œë¹„ìŠ¤ ì‹¤í–‰ì´ë‚˜ ì¸í…íŠ¸ ì†¡ìˆ˜ì‹  ë“±ì˜ ê¸°ëŠ¥ ìˆ˜í–‰ì„ ìš”ì²­í•  ìˆ˜ ìˆë‹¤. ë°˜ëŒ€ë¡œ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” IApplicationThread ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ì˜ ë°”ì¸ë” RPCë¥¼ í†µí•´ ìì‹ ê³¼ ì—°ê²°ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì œì–´í•  ìˆ˜ ìˆë‹¤.  

- Controller ì•¡í‹°ë¹„í‹°ê°€ RPC ë©”ì»¤ë‹ˆì¦˜ì„ í†µí•´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì˜ startService() ìŠ¤í… ë©”ì„œë“œë¥¼ ìì‹ ì˜ ë¡œì»¬ ë©”ì„œë“œì¸ ê²ƒì²˜ëŸ¼ í˜¸ì¶œí•œ ê²ƒìœ¼ë¡œ ìƒê°í•  ìˆ˜ ìˆë‹¤.  

```java
  public boolean onTransact(int code, Parcel data, Parcel reply, int flags){
    switch(code){
      case START_SERVICE_TRANSACTION:{

        data.enforceInterface(IActivityManger.descriptor);
        IBinder b = data.readStrongBuilder();
        IApplicationThread app = ApplicationThreadNative.asInterface(b);
        Intent service = Intent.CREATOR.createFromParcel(data);
        String resolvedType = data.readString();
        Component cn  = startService(app, service, resolvedType);
        return true;
      }
    }
    return super.onTransact(code, data, reply, flags);
  }
```

![íë¦„](https://github.com/keelim/AOSP/blob/master/docs/assets/act1.png?raw=true)

## ì´í›„ í”Œë«í¼ ë³€í™” í•˜ë©´ì„œ IActivityManger ì•ˆì— ì „ë¶€ í†µí•©í•œ ê²ƒ ê°™ë‹¤. -> ì½”ë“œ ë³´ë©´ì„œ

<!-- ì—¬ê¸°ê¹Œì§€ startService() ë¥¼ í˜¸ì¶œì„ í•˜ëŠ” ê³¼ì • -->
<!-- ë’¤ë¶€í„° ì‹¤í–‰ì„ í•˜ëŠ” ê³¼ì • -->

## ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ - startService() ìŠ¤í… ë©”ì„œë“œ ì‹¤í–‰

- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ìš”ì²­ë°›ì€ ì„œë¹„ìŠ¤ë¥¼ ì–´ë–»ê²Œ ì‹¤í–‰í•˜ëŠ”ê°€: ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ startSerã…ice()ì˜ ìŠ¤í… ë©”ì„œë“œë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ê°€
- startService() ìŠ¤í… ë©”ì„œë“œëŠ” startServiceLocked() ë©”ì„œë“œë¥¼ í˜¸ì¶œ  

```java
public ComponentName startService(IApplicationThread caller, Intent service, String resolvedType){
  final int callingPid = Binder.getCallingPid();
  final int callingUid = Binder.getCallingUid();

  ComponentName res = startServiceLocked(caller, service, resolvedType, callingPid, callingUid);

  return res;
}
```

- startServiceLocked() ë©”ì„œë“œëŠ” ì‹¤í–‰í•  ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ ServiceRecord ê°’ì„ ì–»ëŠ”ë‹¤.  
(ServiceRecordëŠ” ì•ˆë“œë¡œì´ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ê°ì¢… ì •ë³´ê°€ ë‹´ê¸´ í´ë˜ìŠ¤ì´ë‹¤.)  
- ì´ë¥¼ ìœ„í•´ startServiceLocked() ë©”ì„œë“œëŠ” retrieveServiceLocked() ë©”ì„œë“œì— ì¸í…íŠ¸ë¥¼ ì „ë‹¬í•´ì„œ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì •ë³´ë¥¼ ì–»ëŠ”ë‹¤  

- ServiceRecord ê°ì²´ë¥¼ bringUpServiceLocked() ë©”ì„œë“œì˜ ì²« ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬  
- ServiceRecord ê°ì²´ë¥¼ ì°¸ì¡°í•´ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  í”„ë¡œì„¸ìŠ¤ ì´ë¦„ê³¼ uidë¥¼ í†µí•´ ProcessRecord ê°ì²´ê°€ ì´ë¯¸ ì¡´ìí•˜ëŠ”ì§€ ê²€ìƒ‰( getProcessRecordLocked() )  
- ProcessRecordê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¡œì»¬ ì„œë¹„ìŠ¤ì˜ ê²½ìš°ì™€ ê°™ì´ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  í”„ë¡œì„¸ìŠ¤ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë¯€ë¡œ realStartServicLocked() ë©”ì„œë“œë¥¼ í†µí•´ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì™€ ë™ì¼í•œ ì˜ì—­ ë‚´ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.  
- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì¶”í›„ì— ìƒˆë¡œ ìƒì„±ëœ í”„ë¡œì„¸ìŠ¤ì—ê²Œ RemoteServiceì˜ ì‹¤í–‰ì„ ìš”ì²­í•˜ê¸° ìœ„í•´ mPendingServices ë°°ì—´ì— ServiceRecord ê°ì²´ë¥¼ ì €ì¥, ì´í›„ ì½”ë“œì—ì„œ Zygoteì— ì˜í•´ ActivityThreadê°€ ìƒˆë¡œ ìƒì„±ëœ í›„ì— mPendingServices ë°°ì—´ì— ì €ì¥í•´ ë†“ì€ ServiceRecord ê°ì²´ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.  

```java
private final ProcessRecord startProcessLocked(String processName, ApplciationInfo info, boolean knownToBeDead, int intentFlags, String hostingType, boolean allowWhileBooting){
  app = newProcessRecordLocked(null, info,processName);

  mProcessNames.put(processName, info.uid, app);
  startProcessLocked(app, hostingType, hostingNameStr);
  return (app.pid!=0) ? app:null;
}

private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr){
  int uid = app.info.uid;
  int[] gids = null;
  int debugFlags = 0;

  gids = mContext.getPackageGids(app.info.packageName);

  int pid = Process.start("android.app.ActivityThread", null, uid, uid, gids, debugsFlags, null);
  this.mPidsSelfLocked.put(pid, app);
}
```

- ActivityManagerService í´ë˜ìŠ¤ ì½”ë“œì—ëŠ” ë‘ ê°œì˜ startProcessLocked() ë©”ì„œë“œê°€ ì¡´ì¬  

(1) 7ê°œ ì¸ì ê°€ì§: ë¦¬ëª¨íŠ¸ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ìƒˆë¡œ ìƒì„±í•  í”„ë¡œì„¸ìŠ¤ ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” ProcessRecord ê°ì²´ë¥¼ ë§Œë“¤ê³ , ì´ë¥¼ mProcessNames íì— ì‚½ì…, ì„±ê³µì ìœ¼ë¡œ ëë‚˜ë©´ ë‘ ë²ˆì§¸ startProcessLocked() ë©”ì„œë“œë¥¼ í˜¸ì¶œ  
(2) Process í´ë˜ìŠ¤ì˜ start() ë©”ì„œë“œë¥¼ í†µí•´ Zygoteì—ê²Œ android.app.ActivityThread í”„ë¡œì„¸ìŠ¤ ìƒì„±ì„ ìš”ì²­, Zygoteì— ì˜í•´ ìƒì„±ëœ í”„ë¡œì„¸ìŠ¤ì˜ pidì™€ ProcessRecord ê°ì²´ë¥¼ mPidsSelfLocked í•´ì‹œì— í‚¤/ê°’ ìŒìœ¼ë¡œ ì €ì¥, ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” pid ê°’ì„ í†µí•´ ì´ì™€ ê´€ë ¨ëœ ProcessRecord ê°ì²´ ê°’ì„ í•´ì‹œë¥¼ í†µí•´ ì–»ì„ ìˆ˜ ìˆë‹¤.  

## ActivityThread í´ë˜ìŠ¤ì˜ main() ë©”ì„œë“œ ì‹¤í–‰

- Zygoteê°€ ì„œë¹„ìŠ¤ ì‹¤í–‰ì„ ìœ„í•´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ìš”ì²­í•œ ActivityThread í´ë˜ìŠ¤ë¥¼ ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ ìƒì—ì„œ ì–´ë–»ê²Œ ì‹¤í–‰í•˜ëŠ”ê°€  
- ActivityThread ì‹¤í–‰ì„ ìš”ì²­ë°›ì€ ZygoteëŠ” ìƒˆë¡œ ìƒì„±í•œ í”„ë¡œì„¸ìŠ¤ì— ActivityThread í´ë˜ìŠ¤ë¥¼ ë¡œë“œí•œ ë‹¤ìŒ, ActivityThread í´ë˜ìŠ¤ì˜ main() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.  
- ActivityThread í´ë˜ìŠ¤ì— í¬í•¨ëœ main() ë©”ì„œë“œ  
  - ë™ì¼í•œ í”„ë¡œì„¸ìŠ¤ ë‚´ì˜ ìŠ¤ë ˆë“œ ê°„ ë©”ì‹œì§€ í†µì‹ ì„ ìœ„í•´ Looper.prepareMainLooper() ë©”ì„œë“œë¥¼ ì´ìš©í•´ì„œ ë©”ì‹œì§€ íë¥¼ ìƒì„±  

- ActivityThreadê°€ ìƒì„±ë˜ê³  ë‚˜ë©´ ì´ ê°ì²´ì˜ attach() ë©”ì„œë“œê°€ í˜¸ì¶œ, attach() ë©”ì„œë“œì˜ ì‹¤ì§ˆì ì¸ ì²˜ë¦¬ëŠ” attachApplication() ìŠ¤í… ë©”ì„œë“œê°€ ë‹´ë‹¹  
- ActivityThreadëŠ” attach() ë©”ì„œë“œë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ë°”ì¸ë” RPCë¥¼ ì´ìš©í•´ì„œ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì œê³µí•˜ëŠ” attachApplication() ìŠ¤í… ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì•¼ í•œë‹¤. ActivityThread ê°ì²´ëŠ” ActivityManagerProxyë¥¼ ìƒì„±í•œ ë‹¤ìŒ ë°”ì¸ë” RPCë¥¼ í†µí•´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•´ì•¼í•œë‹¤. (ActivityManagerProxy ê°ì²´ëŠ” ì•¡í‹°ë¹„í‹°ê°€ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì—ê²Œ íŠ¹ì • ê¸°ëŠ¥ì„ ìš”ì²­í•  ë•Œ ì‚¬ìš©)

```java
public final class ActivityThread {
  //ApplicationThread()
  final ApplicationThread mAppThrea = new ApplciationThread();

  public static void main(String[] args) {
    Looper.prepareMainLooper();
    ActivityThread thread = new ActivityThread();
    thread.attach(false);
    Looper.loop(); // ë©”ì‹œì§€ ë£¨í”„ ì‹¤í–‰
  }

  public void handleMessage(Message msg){
    switch(msg.what){

      case CREATE_SERVICE:
        handleCreateService((CreateServiceData)msg.obj);
        break;

      case SERVICE_ARGS:
        handleServiceArgs((ServiceArgsData)msg.obj);
        break;

      case STOP_SERVICE:
        handleStopService((IBinder)msg.obj);
        maybeSnapShot();
        break;

    }
  }


}
```
<!-- Looper ë‚´ìš© ë„£ê¸° -->
![Looper](https://t1.daumcdn.net/cfile/tistory/232EB335577C080F21)
<!-- attach() ì— ë‚´ìš©ì„ ë“±ë¡ì„ í•´ì£¼ê¸° -->

1. ActiviyThread - ActivityManagerProxy ê°ì²´ì˜ attachApplication() í”„ë¡ì‹œ ë©”ì„œë“œë¥¼ í˜¸ì¶œ  
2. ActivityManaterProxy ê°ì²´ - ActivityManagerNative ê°ì²´ì— ATTACH_APPLICATION_TRANSACTION RPC ì½”ë“œì™€ ë°”ì¸ë” RPC ë°ì´í„°ë¥¼ ì „ì†¡  
3. ActivityManagerNative ê°ì²´ - ActiviyManagerServiceì— í¬í•¨ëœ attachApplication() ìŠ¤í… ë©”ì„œë“œ í˜¸ì¶œ  

=> ì´ ì ˆì˜ ëª©ì ì€ ActivityThreadì™€ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ ê°„ì˜ ìƒí˜¸ì‘ìš©ì„ ìœ„í•œ ë°”ì¸ë” ì—°ê²°ì„ ì„¤ì •í•˜ëŠ” ê²ƒ  

![attach](https://user-images.githubusercontent.com/48465809/58676140-19a1aa80-8392-11e9-9aae-06e59d571484.jpg)

(1) ActivityThread ê°ì²´

```java
private final void attach(boolean system){
  if(!system){
    IActivityManager mgr = ActivityManagerNative.getDefault();
    mgr.attachApplication(mAppThread);
  }
}
```

- attach() ë©”ì„œë“œ: ActivityThreadì™€ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ ê°„ì— IActivityManager ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ì˜ ë°”ì¸ë” RPCë¥¼ ìœ„í•œ ì—°ê²°ì„ ì„¤ì •í•œë‹¤  
- ë°”ì¸ë” RPC ì—°ê²°ì´ ì„¤ì •ë˜ë©´ ActivityThreadëŠ” ActivityManagerProxy ê°ì²´ë¥¼ í†µí•´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì—ê²Œ íŠ¹ì • ì‘ì—…ì„ ìš”ì²­í•  ìˆ˜ ìˆë‹¤  
<!-- ì¶”ê°€ -->

(2) ActivityManagerProxy ê°ì²´

```java
public void attachApplication(IApplicationThread app){
  Parcel data = Parcel.obtain();
  Parcel reply = Parcel.obtain();
  data.writeInterfaceToken(IActivityManager.descriptor);
  data.writeStrongBinder(app.asBinder());
  mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, 0);
}
```

- ActivityManagerProxy ê°ì²´ì˜ attachApplication() í”„ë¡ì‹œ ë©”ì„œë“œ  
- ApplicationThreadì— ëŒ€í•œ ë°”ì¸ë” ê°ì²´ë¥¼ ë§ˆìƒ¬ë§í•´ì„œ RPC ì½”ë“œì™€ ë°”ì¸ë” RPC ë°ì´í„°ë¥¼ ActivityManageNative ê°ì²´ì— ì „ë‹¬í•œë‹¤.  

(3) ActivityManagerNative ê°ì²´

```java
public boolean onTransact(int code, Parcel data, Parcel reply, int ?ags){
  switch(code){

    case ATTACH_APPLICATION_TRANSACTION: {
      IApplicationThread app = ApplicationThreadNative.asInterface(data.readStrongBinder());
      attachApplication(app);
      return true;
    }
  }
}
```

- RPC ì½”ë“œì™€ ë°”ì¸ë” RPC ë°ì´í„°ëŠ” ActivityManagerNative ê°ì²´ì˜ onTransact() ë©”ì„œë“œë¥¼ í†µí•´ ì²˜ë¦¬ëœë‹¤  
- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ActivityThreadì™€ IApplicationThread ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ì˜ ë°”ì¸ë” RPC í†µì‹ ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ApplicationThreadNative.asInterface() ë©”ì„œë“œë¥¼ í†µí•´ ApplicationThreadProxy ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.  
<!-- ì¶”ê°€ -->

## ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ - attachApplication() ìŠ¤í… ë©”ì„œë“œ ì²˜ë¦¬

- attachApplication() ìŠ¤í… ë©”ì„œë“œì˜ ë™ì‘ ê³¼ì •(ê°„ë‹¨íˆ)  
  - Controller ì•¡í‹°ë¹„í‹°ê°€ startService() APIë¥¼ í†µí•´ ì‹¤í–‰ì„ ìš”ì²­í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ ìƒì„±ì„ ActivityThreadì— ëª…ë ¹í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰  
  - Controllerê°€ ìš”ì²­í•œ ì„œë¹„ìŠ¤ì˜ ì‹¤ì œ ìƒì„±ì€ ActivityThreadë¥¼ í†µí•´ ì´ë¤„ì§€ì§€ë§Œ ì´ëŸ¬í•œ ì‘ì—…ì„ ì œì–´í•˜ëŠ” ê²ƒì€ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì˜ attachApplication() ìŠ¤í… ë©”ì„œë“œì´ë‹¤  
  => ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” IApplicationThread ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ì˜ ë°”ì¸ë” RPCë¥¼ ì´ìš©í•´ì„œ ì•ˆë“œë¡œì´ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»´í¬ë„ŒíŠ¸ì¸ ì•¡í‹°ë¹„í‹°, ì„œë¹„ìŠ¤ ë“±ì„ ìƒì„±í•˜ê³  ìƒëª…ì£¼ê¸°ë¥¼ ì œì–´í•œë‹¤.  
  
- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ë°”ì¸ë” RPCë¥¼ í†µí•´ ActivityThreadì—ê²Œ ìƒì„±í•  ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ë„˜ê²¨ ì‹¤ì œ RemoteServiceë¥¼ ì‹¤í–‰

<!-- ì´ë¶€ë¶„ ì•Œê¸° ì‰½ê²Œ -->
1. ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ - ActivityManagerProxy ê°ì²´ì˜ scheduleCreateService() í”„ë¡ì‹œ ë©”ì„œë“œ í˜¸ì¶œ  
2. ActivityManagerProxy ê°ì²´ - ActivityThreadì˜ ActivityManagerNative ê°ì²´ì— SCHEDULE_CREATE_SERVICE_TRANSACTION RPC ì½”ë“œì™€ ë°”ì¸ë” RPC ë°ì´í„° ì „ì†¡  
3. ActivityManagerNative ê°ì²´ - ApplicationCreateServiceì˜ ApplicationThread ê°ì²´ì— í¬í•¨ëœ scheduleCreateService() ìŠ¤í… ë©”ì„œë“œ í˜¸ì¶œ  
4. ApplicationThread ê°ì²´ - ApplicationCreateServiceì˜ ActivityThreadì— ë©”ì‹œì§€íë¥¼ ì´ìš©í•´ CREATE_SERVICE ë©”ì‹œì§€ ì „ë‹¬  
5. ActivityThread ê°ì²´ - RemoteService ì„œë¹„ìŠ¤ ìƒì„± ë° ì„œë¹„ìŠ¤ ìƒëª…ì£¼ê¸°ì— ë”°ë¥¸ onCreate() í˜¸ì¶œ  

### (1) ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ -scheduleCreateService() í”„ë¡ì‹œ ë©”ì„œë“œ í˜¸ì¶œ

- attachApplication() ìŠ¤í… ë©”ì„œë“œëŠ” attachApplicationLocked() ë©”ì„œë“œë¥¼ í˜¸ì¶œ
- ì¸ìë¡œ ApplicationThreadProxy ê°ì²´ì™€ attachApplication() ìŠ¤í… ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œ í”„ë¡œì„¸ìŠ¤ì˜ pidë¥¼ ê°–ëŠ”ë‹¤  

- attachApplicationLocked() ë©”ì„œë“œ  
- í•´ì‹œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì„œ ActivityThread pidë¥¼ í‚¤ ê°’ìœ¼ë¡œ ëŒ€ì‘í•˜ëŠ” value ê°’ì¸ ProcessRecord ê°ì²´ë¥¼ ì–»ëŠ”ë‹¤  
- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” ApplicationThreadProxy ê°ì²´ë¥¼ ì´ìš©í•´ì„œ ì´ ê°ì²´ì™€ ì—°ê²°ëœ ActivityThreadë¥¼ ì œì–´í•  ìˆ˜ ìˆë‹¤.  
- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” ì•ˆë“œë¡œì´ë“œ ì‹œìŠ¤í…œ ë‚´ì˜ ê°ì¢… ActivityThread ìƒì—ì„œ ë™ì‘í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ì œì–´í•´ì•¼í•˜ëŠ” ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ì´ë¯€ë¡œ ì œì–´í•˜ê³ ì í•˜ëŠ” ActivityThreadì™€ ê´€ë ¨ëœ ApplicationThreadProxy ê°ì²´ë¥¼ êµ¬í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì´ í•„ìš”, í”„ë¡œì„¸ìŠ¤ì˜ ê°ì¢… ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” ProcessRecordì— ApplicationThreadProxy ê°ì²´ë¥¼ ì—°ê²°í•˜ë©´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” ì œì–´í•˜ë ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ pidë¥¼ êµ¬í•œ ë‹¤ìŒ ì´ì— í•´ë‹¹í•˜ëŠ” ApplicationThreadProxy ê°ì²´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤.  

- ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ìš”ì²­ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ServiceRecord êµ¬ì¡°ì²´ë¥¼ ì–»ëŠ” ê³¼ì •  
- bringUpServiceLocked() ë©”ì„œë“œì—ì„œëŠ” ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰í•  ì„œë¹„ìŠ¤ì˜ ServiceRecord ê°ì²´ë¥¼ mPendingServices íì— ì €ì¥, mPendingServices.get() ë©”ì„œë“œë¥¼ ì´ìš©í•´ íì— ì €ì¥í–ˆë˜ RemoteServiceì— ëŒ€í•œ ServiceRecord ê°ì²´ë¥¼ ì–»ëŠ”ë‹¤. êµ¬í•œ ProcessRecordì™€ ServiceRecord ê°’ì„ realStartServiceLocked() ë©”ì„œë“œë¡œ ì „ë‹¬  
- app.thread.scheduleCreateService() ë©”ì„œë“œ í˜¸ì¶œ, app.threadì—ëŠ” ì„œë¹„ìŠ¤ ì‹¤í–‰ì„ ìš”ì²­í•œ ActivityThreadë¥¼ ì œì–´í•˜ê¸°ìœ„í•œ ApplicationThreadProxy ê°ì²´ê°€ ì €ì¥ë¼ ìˆë‹¤.  
- ApplicationThreadProxyì˜ scheduleCreateService() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, ì´ë•Œ ì‹¤í–‰í•  ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì •ë³´ê°€ í¬í•¨ëœ ServiceRecord ê°ì²´ ë“±ì´ ì¸ìë¡œ ì „ë‹¬  

### (2) ApplicationThreadProxy ê°ì²´ - ë°”ì¸ë” RPC ë°ì´í„° ì „ì†¡

- ìƒì„±í•  ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì •ë³´ë¥¼ í¬í•¨í•œ ServiceInfo ê°ì²´ë¥¼ RPC ì½”ë“œì™€ ë°”ì¸ë” RPC ë°ì´í„°ë¥¼ í†µí•´ ApplicationThreadNative ê°ì²´ì— ì „ë‹¬  

### (3) ApplicationThreadNative ê°ì²´ - scheduleCreateService() ìŠ¤í… ë©”ì„œë“œ í˜¸ì¶œ

- ìˆ˜ì‹ í•œ ë°”ì¸ë” RPC ë°ì´í„°ë¥¼ onTransact() ë©”ì„œë“œì—ì„œ ì²˜ë¦¬  
- ServiceRecord ê°ì²´ì™€ ServiceInfo ê°ì²´ë¥¼ ì–¸ë§ˆìƒ¬ë§í•œ ë‹¤ìŒ ê°ê° token, info ë³€ìˆ˜ì— ì €ì¥í•˜ê³  ActivityThreadì˜ scheduleCreateService() ìŠ¤í… ë©”ì„œë“œì˜ ì¸ìë¡œ ë„˜ê¸´ë‹¤.  

### (4) ApplicationThread ê°ì²´ - ActivityThreadë¡œ CREATE_SERVICE ë©”ì‹œì§€ ì „ë‹¬

- scheduleCreateService() ìŠ¤í… ë©”ì„œë“œëŠ” ì¸ìë¡œ ì „ë‹¬ëœ ServiceRecordì™€ ServiceInfo ê°ì²´ë¥¼ ì´ìš©í•´ CreateServiceDataë¼ëŠ” ê°ì²´ë¥¼ ë§Œë“  ë‹¤ìŒ ì´ë¥¼ ActivityThread ë©”ì‹œì§€ íì— CREATE_SERVICE ë©”ì‹œì§€ë¡œ ì „ë‹¬  
  - ApplicationThreadëŠ” ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì˜ ì œì–´ ëª…ë ¹ì„ ë°”ì¸ë” RPCë¡œ ìˆ˜ì‹ í•˜ê¸° ìœ„í•œ ìš©ë„, ì‹¤ì œ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ë¡œë¶€í„° ìš”ì²­ë°›ì€ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ì¼ì€ ActivityThreadê°€ ì²˜ë¦¬. ApplicationThreadì™€ ActivityThreadì˜ ê²½ìš° ë™ì¼ í”„ë¡œì„¸ìŠ¤ ì˜ì—­ì—ì„œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ì´ ë‘˜ ì‚¬ì´ì˜ í†µì‹ ì€ ë©”ì‹œí‚¤ íê°€ ì‚¬ìš©  
  
### (5) ActivityThread ê°ì²´ - ì„œë¹„ìŠ¤ ìƒì„± ë° ì„œë¹„ìŠ¤ì˜ onCreate() ë©”ì„œë“œ í˜¸ì¶œ

- ActivityThreadëŠ” ë©”ì‹œì§€ íë¥¼ ìì²´ì ìœ¼ë¡œ ê°€ì§€ê³  ìˆê³  ApplicationThreadë¡œë¶€í„° ìˆ˜ì‹ ëœ ë©”ì‹œì§€ëŠ” handleMessage() ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ì—ì„œ ì²˜ë¦¬ëœë‹¤.  
- ê²°êµ­ ApplicationThreadëŠ” ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ë¡œë¶€í„° ë°”ì¸ë” RPC ë°ì´í„°ë¥¼ í†µí•´ ë°›ì€ ëª…ë ¹ì„ ë©”ì‹œì§€ íë¥¼ í†µí•´ ActivityThreadì— ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•œë‹¤
![ê·¸ë¦¼](https://rudtn082.github.io/images/post/JS9.png)

![ê·¸ë¦¼](https://user-images.githubusercontent.com/48465809/58676147-1e665e80-8392-11e9-80ce-a756eea92552.jpg)

1. Controller Activity -> RemoteService ì‹¤í–‰ ìœ„í•´ startService()`API` ë¥¼ í†µí•´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì— RemoteService ì‹¤í–‰ ìš”ì²­
2. ìš”ì²­ë°›ì€ ì„œë¹„ìŠ¤ê°€ ë¦¬ëª¨íŠ¸ ì„œë¹„ìŠ¤ì¸ ê²½ìš° ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” Zygote ì—ê²Œ ì„œë¹„ìŠ¤ë¥¼ ë³„ë„ì˜ ë…ë¦½ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•´ ActivityThread ìƒì„± ìš”ì²­
3. Zygoteì— ì˜í•´ ìƒì„±ëœ ActivityThreadëŠ” attachApplication() í”„ë¡œì‹œ ë©”ì„œë“œë¥¼ í†µí•´ ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ì—ê²Œ ìì‹  ë“±ë¡, ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ ActivityThread ì œì–´ ê°€ëŠ¥
4. ì•¡í‹°ë¹„í‹° ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ëŠ” 1ìš”ì²­ë°›ì€ RemoteService ìƒì„±ì„ ActivityThreadì— ìš”ì²­
5. ActivityThread ìš”ì²­í–ˆë˜ RemoteService ì„œë¹„ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œ ë‹¤ìŒ ì´ì„œë¹„ìŠ¤ì˜ onCreate()  ì½œë°± í•¨ìˆ˜ë¥¼ í˜¸ì¶œ

### ì°¸ê³ 

- [<https://developer.android.com/>]
- [<http://oss.kr/]>
- ì¸ì‚¬ì´ë“œ ì•ˆë“œë¡œì´ë“œ
- [<https://cs.android.com/>]


#### ğŸ§¶ ëª¨ë“  ë¬¸ì„œëŠ” ìˆ˜ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.